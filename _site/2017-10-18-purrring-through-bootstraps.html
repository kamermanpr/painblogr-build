<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" >

<!-- Head --------------------------------------------------------->

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="generator" content="pandoc"/>
	
	
	 <script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <link href="site_libs/bootstrap-3.3.5/css/yeti.min.css" rel="stylesheet" />
 <script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
 <script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
 <script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
 <script src="site_libs/navigation-1.1/tabsets.js"></script>
 <script src="site_libs/navigation-1.1/codefolding.js"></script>
 <script src="site_libs/kePrint-0.0.1/kePrint.js"></script> 

	
		<style type="text/css">
		code {
			white-space: pre;
		}
	</style>
	<style type="text/css">
		div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #0000ff; } /* Keyword */
code > span.ch { color: #008080; } /* Char */
code > span.st { color: #008080; } /* String */
code > span.co { color: #008000; } /* Comment */
code > span.ot { color: #ff4000; } /* Other */
code > span.al { color: #ff0000; } /* Alert */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #008000; font-weight: bold; } /* Warning */
code > span.cn { } /* Constant */
code > span.sc { color: #008080; } /* SpecialChar */
code > span.vs { color: #008080; } /* VerbatimString */
code > span.ss { color: #008080; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { } /* Variable */
code > span.cf { color: #0000ff; } /* ControlFlow */
code > span.op { } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #ff4000; } /* Preprocessor */
code > span.do { color: #008000; } /* Documentation */
code > span.an { color: #008000; } /* Annotation */
code > span.cv { color: #008000; } /* CommentVar */
code > span.at { } /* Attribute */
code > span.in { color: #008000; } /* Information */  div.sourceCode {
			overflow-x: visible;
		}
		
	</style>

		<style type="text/css">
		pre:not([class]) {
			background-color: white;
		}
	</style>
	   	<style type="text/css">
		h1 {
			font-size: 34px;
		}

		h1.title {
			font-size: 38px;
		}

		h2 {
			font-size: 30px;
		}

		h3 {
			font-size: 24px;
		}

		h4 {
			font-size: 18px;
		}

		h5 {
			font-size: 16px;
		}

		h6 {
			font-size: 12px;
		}

		.table th:not([align]) {
			text-align: left;
		}

		
	</style>
	
		<link rel="stylesheet" href="css/custom.css" type="text/css" />  
    <!-- Latest maxdcn font-awesome and academicons -->
    <link rel="stylesheet" href="./css/font-awesome-4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="./css/academicons-1.7.0/css/academicons.min.css">

    <!-- custom css -->
        <link rel="stylesheet" href="css/custom.css" type="text/css" />
	
    <!-- Include these sections here, otherwise YAML headings not inserted -->
    <!-- Google analytics -->
    <script>
        (function(i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function() {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-71613331-1', 'auto');
        ga('send', 'pageview');
    </script>

    <!-- SEO -->
    <title><em>purrr</em>-ing through bootstrap confidence intervals</title>
    <meta name="description" content="Integrate the boot package into your tidy workflow using purrr.">
    <link rel="author" href="https://plus.google.com/u/0/103355314187199079295" />
    <meta name="robots" content="robots.txt">
    <link rel="canonical" href="https://www.painblogr.org/2017-10-18-purrring-through-bootstraps.html">

    <!-- Twittercard -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@painblogR">
    <meta name="twitter:creator" content="@painblogR">
    <meta name="twitter:title" content="<em>purrr</em>-ing through bootstrap confidence intervals">
    <meta name="twitter:description" content="Integrate the boot package into your tidy workflow using purrr.">
    <meta name="twitter:image" content="./images/posts/2017-10-18-purrring-through-bootstraps/post-image.jpg">
    <meta name="twitter:url" content="https://www.painblogr.org/2017-10-18-purrring-through-bootstraps.html">

    <!-- Opengraph -->
    <meta property="og:title" content="<em>purrr</em>-ing through bootstrap confidence intervals">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://www.painblogr.org/2017-10-18-purrring-through-bootstraps.html">
    <meta property="og:image" content="./images/posts/2017-10-18-purrring-through-bootstraps/post-image.jpg">
    <meta property="og:description" content="Integrate the boot package into your tidy workflow using purrr.">
    <meta property="og:site_name" content="painblogR">
    <meta property="fb:app_id" content="621412384962188">
</head>

<!-- Body --------------------------------------------------------->

<body>
    <!-- Navigation bar -->
    <nav class="navbar navbar-fixed-top" role="navigation" , style="background-color:#FFFFFF;border-bottom: 1px solid #CCCCCC;">
        <div class="container-fluid" id="navfluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar-collapse" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <img src="images/capsaicin.png" alt="logo" , style="max-height:60px;padding-top:5px;">
                <span class="site-title"><a href="https://www.painblogr.org" style="color:#000000;font-size:250%;vertical-align:middle;">
				painblogR</a></span>&emsp;
            </div>

            <div class="collapse navbar-collapse" id="bs-navbar-collapse">
                <ul class="nav navbar-nav" style="display:table-row;padding-top:7px">
                    <li style="display:table-cell;float:none;vertical-align:middle;font-size:16px;"><a href="https://www.painblogr.org">Home</a></li>
                    <li style="display:table-cell;float:none;vertical-align:middle;font-size:16px;"><a href="./archive.html">Archive</a></li>
                    <li class="dropdown" style="display:table-cell;float:none;vertical-align:middle;font-size:16px;">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">About<span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="./about_me.html">About me</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="./publications.html">Publications & Reprints </a></li>
                        </ul>
                    </li>
                    <li class="dropdown" style="display:table-cell;float:none;vertical-align:middle;font-size:16px;">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Teaching<span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="https://www.painblogr.org/biostatistics/">Introduction to Biostatistics</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <!-- /. nav-collapse -->
        </div>
        <!-- /. container-fluid -->
    </nav>

	<!-- Extras -->
		<style type = "text/css">
		code {
  			color: inherit;
  			background-color: rgba(0, 0, 0, 0.04);
		}
		img {
  			max-width:100%;
  			height: auto;
		}
		.tabbed-pane {
  			padding-top: 12px;
		}
		button.code-folding-btn:focus {
  			outline: none;
		}
	</style>

	<div class="container-fluid main-container">
		<!-- tabsets -->
		<script src="/tabsets.js"></script>
		<script>
			$(document).ready(function () {
  			window.buildTabsets("TOC");
			});
		</script>

		<!-- code folding -->
				<style type="text/css">
			code-folding-btn { margin-bottom: 4px; }
		</style>
		<script src="/codefolding.js"></script>
					<script>

		$(document).ready(function () {
			
			  			window.initializeCodeFolding("show" === "show");
					});
		</script>
		
		<div class="fluid-row" id="header">
<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>

    <!-- Main text --->
    <div class="container-fluid" id="mainbody">
         
        <h1><em>purrr</em>-ing through bootstrap confidence intervals</h1> 
        <h4>Peter Kamerman</h4> 
        <em>18 October 2017</em> <p><br></p>
<p><img src="images/posts/2017-10-18-purrring-through-bootstraps/post-image.jpg" style="float:left;width:300px;height:auto;padding-right:20px;" /> Packages in the <a href="https://www.tidyverse.org/"><code>tidyverse</code></a> provide the backbone for much of the grunt work I do on new datasets. Just about all my needs for importing, wrangling, plotting, and summarising the data can be accomplished from withn the <code>tidyverse</code>, and this functionality is augmented by the growing number of packages that play nicely with the <code>tidyverse</code>. For example, when it comes to generating bootstrap confidence intervals for a statistic (e.g., mean), there are packages such as <a href="https://cran.r-project.org/web/packages/broom/index.html"><code>broom</code></a> (see this <a href="https://cran.r-project.org/web/packages/broom/vignettes/bootstrapping.html">vignette</a>), <a href="https://cran.r-project.org/web/packages/tidyboot/index.html"><code>tidyboot</code></a>, and <a href="https://github.com/jtleek/slipper"><code>slipper</code></a>.</p>
<p>To the best of my knowledge these packages calculate basic or percentile bootstrap confidence intervals, which are super easy to calculate and work well if the statistic you are calculating is well behaved (i.e., the bootstrap distribution is smooth, symmetrical, and centered on the observed statistic). But, if the bootstrap distribution of your statistic is not well behaved, a potential problem when you are dealing with small sample sizes (a situation I often find myself in), then you need an interval that is a bit more robust <a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>. These more robust intervals, such as bias-corrected accelerated (BCa) confidence intervals, are much tricker to calculate than basic and percentile intervals, and that is where the <a href="https://cran.r-project.org/web/packages/boot/index.html"><code>boot</code></a> package comes in. The <code>boot</code> package gives you the option of calculating five types of non-parametric bootstrap confidence intervals (first-order normal approximation, basic, studentized, percentile, and BCa intervals); it’s the bomb.</p>
<p>Yet, my use of <code>boot</code> to calculate confidence intervals has been thwarted by the fact that <code>boot</code> doesn’t play nicely with routinely used <code>tidyverse</code> functions such as <code>dplyr::summarise</code>. I think the issue is related to the use of non-standard evaluation within <code>tidyverse</code> packages, but whatever the reason, I have always battled to integrate <code>boot</code> into my <code>tidyverse</code> workflow <a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a>.</p>
<p>My troubles came to an end the other day when I realised that I could harness list-columns and the <a href="https://cran.r-project.org/web/packages/purrr/index.html"><code>purrr</code></a> package to use the <code>boot</code> package within the <code>tidyverse</code>. I must admit that I have long thought that list-columns were the Devil’s work, but maybe that was because I didn’t have a practical use for them until now. Whatever your thoughts on list-columns, what follows is a reproducible example of using <code>purrr</code>, <a href="https://cran.r-project.org/web/packages/tidyr/index.html"><code>tidyr</code></a>, <a href="https://cran.r-project.org/web/packages/dplyr/index.html"><code>dplyr</code></a>, and <code>boot</code> to calculate BCa confidence intervals of median sepal width for each of the iris species in the <strong>iris</strong> dataset.</p>
<p>But, before getting down to calculating the confidence intervals, let’s get a feel for the <strong>iris</strong> dataset:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Top 6 rows of &quot;iris&quot;</span>
<span class="kw">head</span>(iris)</code></pre></div>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1          5.1         3.5          1.4         0.2  setosa
## 2          4.9         3.0          1.4         0.2  setosa
## 3          4.7         3.2          1.3         0.2  setosa
## 4          4.6         3.1          1.5         0.2  setosa
## 5          5.0         3.6          1.4         0.2  setosa
## 6          5.4         3.9          1.7         0.4  setosa</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Structure of &quot;iris&quot;</span>
dplyr<span class="op">::</span><span class="kw">glimpse</span>(iris)</code></pre></div>
<pre><code>## Observations: 150
## Variables: 5
## $ Sepal.Length &lt;dbl&gt; 5.1, 4.9, 4.7, 4.6, 5.0, 5.4, 4.6, 5.0, 4.4, 4.9, 5…
## $ Sepal.Width  &lt;dbl&gt; 3.5, 3.0, 3.2, 3.1, 3.6, 3.9, 3.4, 3.4, 2.9, 3.1, 3…
## $ Petal.Length &lt;dbl&gt; 1.4, 1.4, 1.3, 1.5, 1.4, 1.7, 1.4, 1.5, 1.4, 1.5, 1…
## $ Petal.Width  &lt;dbl&gt; 0.2, 0.2, 0.2, 0.2, 0.2, 0.4, 0.3, 0.2, 0.2, 0.1, 0…
## $ Species      &lt;fct&gt; setosa, setosa, setosa, setosa, setosa, setosa, set…</code></pre>
<p>As you can see, <strong>iris</strong> is a dataframe consisting of five columns, and 150 rows. The first four columns report sepal and petal dimensions of irises, and the fifth column provides the names of the three species of iris associated with each measurement (50 measurements per species).</p>
<div id="nesting-the-data" class="section level3">
<h3>Nesting the data</h3>
<p>As I wrote above, the aim is to calculate BCa confidence intervals of median sepal width (<em>“Sepal.Width”</em>) for each species (for convention, I’ll calculate 95% confidence intervals). The 1<sup>st</sup> step in the calculation is to create a list-column of the petal and sepal dimension data nested (grouped) by species using <code>dplyr::group_by</code> and <code>tidyr::nest</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Load magrittr package for pipe functions</span>
<span class="kw">library</span>(magrittr)

<span class="co"># Nest the data</span>
iris_nest &lt;-<span class="st"> </span>iris <span class="op">%&gt;%</span>
<span class="st">    </span><span class="co"># First I group the data by species </span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw">group_by</span>(Species) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="co"># Then I nest the dataframe</span>
<span class="st">    </span>tidyr<span class="op">::</span><span class="kw">nest</span>()</code></pre></div>
<p>If we print the resulting <strong>iris_nest</strong> dataframe (see below), the original 150 x 5 <strong>iris</strong> dataframe has been transformed into a 3 x 2 dataframe, with the 1<sup>st</sup> column being our nesting variable <em>“Species”</em>, and the 2<sup>nd</sup> column (named <em>“data”</em> by default) being a list-column of 50 x 4 dataframes (&lt;tibble [50 x 4]&gt;).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Print &quot;iris_nest&quot;</span>
iris_nest</code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   Species    data             
##   &lt;fct&gt;      &lt;list&gt;           
## 1 setosa     &lt;tibble [50 × 4]&gt;
## 2 versicolor &lt;tibble [50 × 4]&gt;
## 3 virginica  &lt;tibble [50 × 4]&gt;</code></pre>
<p>Inspecting the tibbles in the list-column (see below) reveals that each row of the list-column contains the sepal and petal dimensions for the iris species named in the corresponding row of the <em>“Species”</em> column.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Print the top six rows of the each row in the &quot;data&quot; list-column</span>
<span class="kw">lapply</span>(iris_nest<span class="op">$</span>data, head)</code></pre></div>
<pre><code>## [[1]]
## # A tibble: 6 x 4
##   Sepal.Length Sepal.Width Petal.Length Petal.Width
##          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;
## 1          5.1         3.5          1.4         0.2
## 2          4.9         3            1.4         0.2
## 3          4.7         3.2          1.3         0.2
## 4          4.6         3.1          1.5         0.2
## 5          5           3.6          1.4         0.2
## 6          5.4         3.9          1.7         0.4
## 
## [[2]]
## # A tibble: 6 x 4
##   Sepal.Length Sepal.Width Petal.Length Petal.Width
##          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;
## 1          7           3.2          4.7         1.4
## 2          6.4         3.2          4.5         1.5
## 3          6.9         3.1          4.9         1.5
## 4          5.5         2.3          4           1.3
## 5          6.5         2.8          4.6         1.5
## 6          5.7         2.8          4.5         1.3
## 
## [[3]]
## # A tibble: 6 x 4
##   Sepal.Length Sepal.Width Petal.Length Petal.Width
##          &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;
## 1          6.3         3.3          6           2.5
## 2          5.8         2.7          5.1         1.9
## 3          7.1         3            5.9         2.1
## 4          6.3         2.9          5.6         1.8
## 5          6.5         3            5.8         2.2
## 6          7.6         3            6.6         2.1</code></pre>
</div>
<div id="take-a-bootstrap-sample" class="section level3">
<h3>Take a bootstrap sample</h3>
<p>Now that the data are nested, we can move on to bootstrapping the median sepal width. The first step when using <code>boot::boot</code> (the core function in the package, which performs the resampling) is to provide a user-defined function that calculates the statistic of interest. In this case I define a function <code>boot_median</code> that calculates the median of a dataset. In its simplist form, this function has two parameters, <em>d</em> and <em>i</em>, where <em>d</em> is the data that will be used to sample from, and <em>i</em> is an index parameter used by the internals of <code>boot::boot</code> to take a random sample (with replacement) from <em>d</em>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Define the bootstrap function</span>
boot_median &lt;-<span class="st"> </span><span class="cf">function</span>(d, i) {
    <span class="kw">median</span>(d[i])
}</code></pre></div>
<p>After defining the <code>boot_median</code> function, we then use <code>purrr::map</code> within the <code>dplyr::mutate</code> function to add another list-column to <strong>iris_nest</strong>, in which each row contains the object returned by mapping the <code>boot::boot</code> function (which is responsible for applying the <code>bootstrap_median</code> function) over the tibbles stored in each row of the <em>“data”</em> list-column.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Add a list column called &quot;booted&quot; containing the object produced by `</span>
<span class="co"># applying `boot::boot` over the data in the &quot;data&quot; list-column.</span>
iris_nest <span class="op">%&lt;&gt;%</span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">booted =</span> purrr<span class="op">::</span><span class="kw">map</span>(<span class="dt">.x =</span> data, <span class="co"># The list-column containing &lt;S3: tibble&gt;</span>
                                      <span class="op">~</span><span class="st"> </span>boot<span class="op">::</span><span class="kw">boot</span>(<span class="dt">data =</span> .x<span class="op">$</span>Petal.Length, <span class="co"># The &lt;S3 tibble&gt; column being sampled</span>
                                                 <span class="dt">statistic =</span> boot_median, <span class="co"># The user-defined function</span>
                                                 <span class="dt">R =</span> <span class="dv">10000</span>, <span class="co"># The number of replicates</span>
                                                 <span class="dt">stype =</span> <span class="st">&quot;i&quot;</span>)))</code></pre></div>
<p>If we inspect <strong>iris_nest</strong> (see below), we see that there are now three columns, and the new column, <em>“booted”</em> is a list-column, with each row containing an S3 object of class “boot” (&lt;S3: boot&gt;).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Print &quot;iris_nest&quot;</span>
iris_nest</code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   Species    data              booted    
##   &lt;fct&gt;      &lt;list&gt;            &lt;list&gt;    
## 1 setosa     &lt;tibble [50 × 4]&gt; &lt;S3: boot&gt;
## 2 versicolor &lt;tibble [50 × 4]&gt; &lt;S3: boot&gt;
## 3 virginica  &lt;tibble [50 × 4]&gt; &lt;S3: boot&gt;</code></pre>
<p>It’s always wise to inspect the bootstrap distribution of a statistic, which we can do graphically by plotting the contents of each of the &lt;S3: boot&gt; objects contained in the <em>“booted”</em> list-column. This task can be achieved by mapping the <code>plot</code> function over the list-column. Each output contains two side-by-side plots, the left plot shows a histogram of the bootstrap replicates, and the right plot shows a Q-Q plot (using normal quantiles) of the bootstrap replicates.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Plot each &lt;S3: boot&gt; object</span>
## Note: Saved to an object (plots) to stop the summary being printed
plots &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map</span>(<span class="dt">.x =</span> iris_nest<span class="op">$</span>booted, 
                    <span class="op">~</span><span class="st"> </span><span class="kw">plot</span>(.x))</code></pre></div>
<p><img src="2017-10-18-purrring-through-bootstraps_files/figure-html/boot_plot-1.png" width="672" /><img src="2017-10-18-purrring-through-bootstraps_files/figure-html/boot_plot-2.png" width="672" /><img src="2017-10-18-purrring-through-bootstraps_files/figure-html/boot_plot-3.png" width="672" /></p>
</div>
<div id="calculate-the-confidence-interval" class="section level3">
<h3>Calculate the confidence interval</h3>
<p>Clearly the bootstrap distribution of median sepal width for all three species of iris is “lumpy” and “skew”. Yes, I could have chosen a better illustrative dataset to analyse, but for our purpose of this blog post we proceed to calculate BCa intervals. To calculate the intervals, we repeat the procedure used to generate the bootstrap sample in the previous step, but this time we shall map <code>boot::boot.ci</code> over each row of the &lt;S3: boot&gt; objects contained in the <em>“booted”</em> list-column. The <code>boot::boot.ci</code> function generates the confidence interval using the bootstrap replicates generated by <code>boot::boot</code>, with the user defining which type of interval shopuld be calculated (first-order normal approximation, basic, studentized, percentile, or BCa).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Add a list column called &quot;booted_ci&quot; containing the object produced by `</span>
<span class="co"># applying `boot::boot.ci` over the data in the &quot;booted&quot; list-column.</span>
iris_nest <span class="op">%&lt;&gt;%</span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">booted_ci =</span> purrr<span class="op">::</span><span class="kw">map</span>(<span class="dt">.x =</span> booted, <span class="co"># The list-column containing &lt;S3: boot&gt; objects</span>
                                         <span class="op">~</span><span class="st"> </span>boot<span class="op">::</span><span class="kw">boot.ci</span>(.x,
                                                         <span class="dt">conf =</span> <span class="fl">0.95</span>, <span class="co"># Interval width</span>
                                                         <span class="dt">type =</span> <span class="st">&quot;bca&quot;</span>)))  <span class="co"># Calculate a BCa interval</span></code></pre></div>
<p>If you print <strong>iris_nest</strong>, there is now a 4<sup>th</sup> column, <em>“booted_ci”</em>, which is a list-column with each row containing the S3 “bootci” object (&lt;S3 bootci&gt;) output of <code>boot::boot.ci</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Print &quot;iris_nest&quot;</span>
iris_nest</code></pre></div>
<pre><code>## # A tibble: 3 x 4
##   Species    data              booted     booted_ci   
##   &lt;fct&gt;      &lt;list&gt;            &lt;list&gt;     &lt;list&gt;      
## 1 setosa     &lt;tibble [50 × 4]&gt; &lt;S3: boot&gt; &lt;S3: bootci&gt;
## 2 versicolor &lt;tibble [50 × 4]&gt; &lt;S3: boot&gt; &lt;S3: bootci&gt;
## 3 virginica  &lt;tibble [50 × 4]&gt; &lt;S3: boot&gt; &lt;S3: bootci&gt;</code></pre>
<p>As with the bootstrap distribution plots, the content of these &lt;S3 bootci&gt; objects can be easily extracted by mapping the <code>print</code> function over the list-column (see below). But while this prints out a nice summary, the output is not in a readily usable form, and is definitely not in a tidy format.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Plot each &lt;S3: bootci&gt; object</span>
prints &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map</span>(<span class="dt">.x =</span> iris_nest<span class="op">$</span>booted_ci, 
                     <span class="op">~</span><span class="st"> </span><span class="kw">print</span>(.x))</code></pre></div>
<pre><code>## BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
## Based on 10000 bootstrap replicates
## 
## CALL : 
## boot::boot.ci(boot.out = .x, conf = 0.95, type = &quot;bca&quot;)
## 
## Intervals : 
## Level       BCa          
## 95%   ( 1.4,  1.5 )  
## Calculations and Intervals on Original Scale
## BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
## Based on 10000 bootstrap replicates
## 
## CALL : 
## boot::boot.ci(boot.out = .x, conf = 0.95, type = &quot;bca&quot;)
## 
## Intervals : 
## Level       BCa          
## 95%   ( 4.1,  4.5 )  
## Calculations and Intervals on Original Scale
## BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS
## Based on 10000 bootstrap replicates
## 
## CALL : 
## boot::boot.ci(boot.out = .x, conf = 0.95, type = &quot;bca&quot;)
## 
## Intervals : 
## Level       BCa          
## 95%   ( 5.20,  5.65 )  
## Calculations and Intervals on Original Scale</code></pre>
</div>
<div id="make-it-tidy" class="section level3">
<h3>Make it tidy</h3>
<p>The last step is to get the information from the &lt;S3 bootci&gt; object into a tidy dataframe. And, again we use <code>purrr::map</code> within <code>dplyr::mutate</code> to add columns containing the relevant data extracted from each &lt;S3 bootci&gt; object in the <em>“booted_ci”</em> list-column. Because a &lt;S3 bootci&gt; object is simply a list, the information can be extracted using standard indexing (“$” and “[”). But, indexing requires knowing where the data are located in an object, and so we must inspect the structure of the &lt;S3 bootci&gt; object.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Inspect the structure of an &lt;S3 bootci&gt; object</span>
<span class="kw">str</span>(iris_nest<span class="op">$</span>booted_ci[[<span class="dv">1</span>]])</code></pre></div>
<pre><code>## List of 4
##  $ R   : int 10000
##  $ t0  : num 1.5
##  $ call: language boot::boot.ci(boot.out = .x, conf = 0.95, type = &quot;bca&quot;)
##  $ bca : num [1, 1:5] 0.95 121 9524.48 1.4 1.5
##   ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. ..$ : NULL
##   .. ..$ : chr [1:5] &quot;conf&quot; &quot;&quot; &quot;&quot; &quot;&quot; ...
##  - attr(*, &quot;class&quot;)= chr &quot;bootci&quot;</code></pre>
<p>The &lt;S3 bootci&gt; object is a list of length four, and the data to be extracted is located within <em>t0</em> (the observed value of the statistic), and the 4<sup>th</sup> and 5<sup>th</sup> elements of <em>bca</em> (the 2.5% and 97.5% confidence limits, respectively). With this information in hand, the relevant data can be extracted.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Add a three column called &quot;statistic&quot; (point estimate), &quot;lower_ci&quot; (2.5% CI), and </span>
<span class="co"># &quot;upper_ci&quot; (97.5% CI), which are populated by data extracted using `purrr::map` </span>
<span class="co"># from the &lt;S3 bootci&gt; objects in the &quot;booted_ci&quot; list-column. </span>
iris_booted &lt;-<span class="st"> </span>iris_nest <span class="op">%&gt;%</span>
<span class="st">    </span><span class="co"># Add columns</span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">statistic =</span> purrr<span class="op">::</span><span class="kw">map</span>(<span class="dt">.x =</span> booted_ci, <span class="co"># The list-column containing &lt;S3 bootci&gt; objects</span>
                                         <span class="op">~</span><span class="st"> </span>.x<span class="op">$</span>t0), <span class="co"># The point estimate</span>
                  <span class="dt">lower_ci =</span> purrr<span class="op">::</span><span class="kw">map</span>(<span class="dt">.x =</span> booted_ci,
                                        <span class="op">~</span><span class="st"> </span>.x<span class="op">$</span>bca[[<span class="dv">4</span>]]), <span class="co"># The value of the lower 2.5% limit</span>
                  <span class="dt">upper_ci =</span> purrr<span class="op">::</span><span class="kw">map</span>(<span class="dt">.x =</span> booted_ci,
                                        <span class="op">~</span><span class="st"> </span>.x<span class="op">$</span>bca[[<span class="dv">5</span>]])) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># The value of teh upper 97.5% limit</span>
<span class="st">    </span><span class="co"># Drop the list-columns (no longer needed)</span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span>data, <span class="op">-</span>booted, <span class="op">-</span>booted_ci) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="co"># Unnest the dataframe</span>
<span class="st">    </span>tidyr<span class="op">::</span><span class="kw">unnest</span>()</code></pre></div>
<p>And for the “big reveal”, printing <strong>iris_booted</strong> gives a 3 x 4 dataframe with one class “factor” column (<em>“Species”</em>), and three class “double” columns (<em>“statistic”</em>, <em>“lower_ci”</em>, <em>“upper_ci”</em>). Each column contains data for one variable, and different observations of each variable are in different rows. As such, the dataframe can be considered tidy and the data are easy to work with.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Print the tidy dataframe</span>
iris_booted</code></pre></div>
<pre><code>## # A tibble: 3 x 4
##   Species    statistic lower_ci upper_ci
##   &lt;fct&gt;          &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1 setosa          1.5       1.4     1.5 
## 2 versicolor      4.35      4.1     4.5 
## 3 virginica       5.55      5.2     5.65</code></pre>
<p>So, by using the <code>purrr</code> package, it is possible to easily integrate the calculation of bootstrap intervals using the <code>boot</code> package into your tidy workflow. Obviously the steps I describe here can be simplified, but hopefully giving a step-by-step guide will be helpful to someone out there.</p>
<hr />
</div>
<div id="extra" class="section level3">
<h3>Extra</h3>
<p>If you are drafting a report and want to make a pretty table of the data, then you simply need to pass the data through <code>knitr::kable</code> (with <code>kableExtra</code> if you want some extra bells and whistles).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Using `knitr::kable` only</span>
knitr<span class="op">::</span><span class="kw">kable</span>(<span class="dt">x =</span> iris_booted, 
             <span class="dt">digits =</span> <span class="dv">1</span>, 
             <span class="dt">col.names =</span> <span class="kw">c</span>(<span class="st">&quot;Species&quot;</span>,
                           <span class="st">&quot;Median sepal width(mm)&quot;</span>,
                           <span class="st">&quot;Lower 2.5% limit&quot;</span>,
                           <span class="st">&quot;Upper 97.5% limit&quot;</span>))</code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">Species</th>
<th align="right">Median sepal width(mm)</th>
<th align="right">Lower 2.5% limit</th>
<th align="right">Upper 97.5% limit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">setosa</td>
<td align="right">1.5</td>
<td align="right">1.4</td>
<td align="right">1.5</td>
</tr>
<tr class="even">
<td align="left">versicolor</td>
<td align="right">4.3</td>
<td align="right">4.1</td>
<td align="right">4.5</td>
</tr>
<tr class="odd">
<td align="left">virginica</td>
<td align="right">5.5</td>
<td align="right">5.2</td>
<td align="right">5.7</td>
</tr>
</tbody>
</table>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Adding some bells and whistles with `kableExtra</span>
knitr<span class="op">::</span><span class="kw">kable</span>(<span class="dt">x =</span> iris_booted, 
             <span class="dt">format =</span> <span class="st">&#39;html&#39;</span>,
             <span class="dt">digits =</span> <span class="dv">1</span>, 
             <span class="dt">col.names =</span> <span class="kw">c</span>(<span class="st">&quot;&quot;</span>,
                           <span class="st">&quot;Median&quot;</span>,
                           <span class="st">&quot;Lower 2.5% limit&quot;</span>,
                           <span class="st">&quot;Upper 97.5% limit&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span>kableExtra<span class="op">::</span><span class="kw">add_header_above</span>(<span class="kw">c</span>(<span class="st">&quot;Species&quot;</span> =<span class="st"> </span><span class="dv">1</span>,
                                   <span class="st">&quot;Sepal width (mm)&quot;</span> =<span class="st"> </span><span class="dv">3</span>))</code></pre></div>
<table>
<thead>
<tr>
<th style="border-bottom:hidden; padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="1">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Species
</div>
</th>
<th style="border-bottom:hidden; padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; " colspan="3">
<div style="border-bottom: 1px solid #ddd; padding-bottom: 5px; ">
Sepal width (mm)
</div>
</th>
</tr>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
Median
</th>
<th style="text-align:right;">
Lower 2.5% limit
</th>
<th style="text-align:right;">
Upper 97.5% limit
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
setosa
</td>
<td style="text-align:right;">
1.5
</td>
<td style="text-align:right;">
1.4
</td>
<td style="text-align:right;">
1.5
</td>
</tr>
<tr>
<td style="text-align:left;">
versicolor
</td>
<td style="text-align:right;">
4.3
</td>
<td style="text-align:right;">
4.1
</td>
<td style="text-align:right;">
4.5
</td>
</tr>
<tr>
<td style="text-align:left;">
virginica
</td>
<td style="text-align:right;">
5.5
</td>
<td style="text-align:right;">
5.2
</td>
<td style="text-align:right;">
5.7
</td>
</tr>
</tbody>
</table>
<hr />
</div>
<div id="session-information" class="section level2">
<h2>Session information</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sessionInfo</span>()</code></pre></div>
<pre><code>## R version 3.5.2 (2018-12-20)
## Platform: x86_64-apple-darwin15.6.0 (64-bit)
## Running under: macOS Mojave 10.14.3
## 
## Matrix products: default
## BLAS: /Library/Frameworks/R.framework/Versions/3.5/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/3.5/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] magrittr_1.5          geojsonio_0.6.0       lubridate_1.7.4      
##  [4] xml2_1.2.0            sp_1.3-1              leaflet_2.0.2        
##  [7] highcharter_0.7.0     flexdashboard_0.5.1.1 gganimate_1.0.2      
## [10] gdtools_0.1.7         ggiraph_0.6.0         svglite_1.2.1        
## [13] pander_0.6.3          knitr_1.21            forcats_0.4.0        
## [16] stringr_1.4.0         dplyr_0.8.0.1         purrr_0.3.1          
## [19] readr_1.3.1           tidyr_0.8.3           tibble_2.0.1         
## [22] ggplot2_3.1.0         tidyverse_1.2.1      
## 
## loaded via a namespace (and not attached):
##  [1] nlme_3.1-137      sf_0.7-3          xts_0.11-2       
##  [4] webshot_0.5.1     progress_1.2.0    httr_1.4.0       
##  [7] tools_3.5.2       backports_1.1.3   utf8_1.1.4       
## [10] rgdal_1.3-9       R6_2.4.0          rgeos_0.4-2      
## [13] DBI_1.0.0         lazyeval_0.2.1    colorspace_1.4-0 
## [16] withr_2.1.2.9000  tidyselect_0.2.5  prettyunits_1.0.2
## [19] curl_3.3          compiler_3.5.2    cli_1.0.1        
## [22] rvest_0.3.2       labeling_0.3      scales_1.0.0     
## [25] classInt_0.3-1    digest_0.6.18     foreign_0.8-71   
## [28] rmarkdown_1.11    pkgconfig_2.0.2   htmltools_0.3.6  
## [31] highr_0.7         htmlwidgets_1.3   rlang_0.3.1      
## [34] readxl_1.3.0      TTR_0.23-4        rstudioapi_0.9.0 
## [37] quantmod_0.4-13   shiny_1.2.0       farver_1.1.0     
## [40] generics_0.0.2    zoo_1.8-4         jsonlite_1.6     
## [43] crosstalk_1.0.0   rlist_0.4.6.1     kableExtra_1.0.1 
## [46] fansi_0.4.0       Rcpp_1.0.0        munsell_0.5.0    
## [49] stringi_1.3.1     whisker_0.3-2     yaml_2.2.0       
## [52] jqr_1.1.0         plyr_1.8.4        maptools_0.9-5   
## [55] grid_3.5.2        promises_1.0.1    crayon_1.3.4     
## [58] lattice_0.20-38   haven_2.1.0       geojson_0.3.2    
## [61] hms_0.4.2         pillar_1.3.1      igraph_1.2.4     
## [64] boot_1.3-20       glue_1.3.0        evaluate_0.13    
## [67] V8_2.0            data.table_1.12.0 modelr_0.1.4     
## [70] tweenr_1.0.1      httpuv_1.4.5.1    cellranger_1.1.0 
## [73] gtable_0.2.0      assertthat_0.2.0  xfun_0.5         
## [76] mime_0.6          xtable_1.8-3      broom_0.5.1      
## [79] e1071_1.7-0.1     later_0.8.0       class_7.3-15     
## [82] viridisLite_0.3.0 units_0.6-2</code></pre>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Efron B, Tibshirani R. Bootstrap methods for standard errors, confidence intervals, and other measures of statistical accuracy. Stat. Sci. 1986;1:54–75. doi: <a href="https://doi.org/10.1214/ss/1177013815">10.1214/ss/1177013815</a>.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>I fully accept that this shortcoming may merely reflect a lack of skill on my part.<a href="#fnref2">↩</a></p></li>
</ol>
</div>

        <!-- Include these sections here, otherwise YAML headings not inserted -->
        <!-- Share -->
        <div class="share">
            <p style="display:inline-block">
                <hr>
                <h3>Share</h3>&ensp;
                <a href="mailto:?subject=<em>purrr</em>-ing through bootstrap confidence intervals&body=Hi, I thought you might like this post I found on painblogR:%0D%0A%0D%0Ahttps://www.painblogr.org/2017-10-18-purrring-through-bootstraps.html.%0D%0A%0D%0ABest regards" target="_blank"><i class="fa fa-envelope" style="color:#000000;vertical-align:middle;" title="Share on email" ></i></a>&ensp;
                <a href="https://twitter.com/intent/tweet?url=https://www.painblogr.org/2017-10-18-purrring-through-bootstraps.html&text=<em>purrr</em>-ing through bootstrap confidence intervals&via=painblogR" rel="nofollow" target="_blank" title="Share on Twitter"><i class="fa fa-twitter" style="color:#000000;vertical-align:middle;"></i></a>&ensp;
                <a href="https://facebook.com/sharer.php?u=https://www.painblogr.org/2017-10-18-purrring-through-bootstraps.html" rel="nofollow" target="_blank" title="Share on Facebook"><i class="fa fa-facebook" style="color:#000000;vertical-align:middle;"></i></a>&ensp;
                <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.painblogr.org/2017-10-18-purrring-through-bootstraps.html" rel="nofollow" target="_blank" title="Share on LinkedIn"><i class="fa fa-linkedin" style="color:#000000;vertical-align:middle;"></i></a>
            </p>
        </div>

        <!-- Disqus
        <div class="comments">
            <hr>
            <h3>Comments</h3>
            <div id="disqus_thread"></div>
            <script>
                var disqus_config = function() {
                    this.page.url = 'https://www.painblogr.org/2017-10-18-purrring-through-bootstraps.html'
                    this.page.identifier = '/2017-10-18-purrring-through-bootstraps.html'
                };

                (function() {
                    var d = document,
                        s = d.createElement('script');

                    s.src = 'https://www.painblogr.disqus.com/embed.js';
                    s.setAttribute('data-timestamp', +new Date());
                    (d.head || d.body).appendChild(s);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
            </noscript>
        </div>
    </div> -->

    <!-- Footer -->
    <footer>
         <!--footer-->
 <div class="container-fluid" id="foot" style="background-color:#FFFFFF;border-top:#CCCCCC solid 1px;color:#999999;font-family:'Open sans', 'Helvetica';">
     <div class="row">
         <div class="col-sm-4">
             <p>Hosted by: <a href="https://www.netlify.com" target="_blank">netlify.com</a>
                 <br>Powered by: <a href="http://rmarkdown.rstudio.com/" target="_blank">RMarkdown</a>
                 <br>
                 <br>
             </p>
         </div>
         <div class="col-sm-4">
             <p>Fork/clone from: <a href="https://github.com/kamermanpr/kamermanpr.github.io.git" target="_blank">GitHub</a>
                 <br>License: <a href="./LICENSE.html" target="_blank">MIT & CC-BY 4.0</a>
                 <br>
                 <br>
             </p>
         </div>
         <div class="col-sm-4">
             <h4 style="padding:0;margin:0">painblogR</h3>
 			   <p style="display:inline-block">
 				   <span style="font-style:italic">by Peter Kamerman</span>
 				   &ensp;
 				   <a href="mailto:peter.kamerman@gmail.com" title="Email me" target="_blank"><i style="color:#999999;" class="fa fa-envelope"></i></a>
 				   &ensp;
 				   <a href="//twitter.com/@painblogR" target="_blank" title="Follow me"><i style="color:#999999;" class="fa fa-twitter"></i></a>
 			   </p>
 		   </div>
 	   </div>
 	</div> 
    </footer>
</body>

<!-- extras ------------------------------------------------------->
<!-- Mathjax -->

</html>
